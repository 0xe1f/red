#!/usr/bin/env python3
import sys, os, mmap, struct

args = sys.argv[1:]
if not args:
    print("Error: no arguments supplied", file=sys.stderr)
    sys.exit(1)

PATH = "/tmp/red_game_server_keypress"
SIZE = 128

keymap = {
    "sdlk_backspace": 8,
    "sdlk_tab": 9,
    "sdlk_clear": 12,
    "sdlk_return": 13,
    "sdlk_pause": 19,
    "sdlk_escape": 27,
    "sdlk_space": 32,
    "sdlk_exclaim": 33,
    "sdlk_quotedbl": 34,
    "sdlk_hash": 35,
    "sdlk_dollar": 36,
    "sdlk_ampersand": 38,
    "sdlk_quote": 39,
    "sdlk_leftparen": 40,
    "sdlk_rightparen": 41,
    "sdlk_asterisk": 42,
    "sdlk_plus": 43,
    "sdlk_comma": 44,
    "sdlk_minus": 45,
    "sdlk_period": 46,
    "sdlk_slash": 47,
    "sdlk_0": 48,
    "sdlk_1": 49,
    "sdlk_2": 50,
    "sdlk_3": 51,
    "sdlk_4": 52,
    "sdlk_5": 53,
    "sdlk_6": 54,
    "sdlk_7": 55,
    "sdlk_8": 56,
    "sdlk_9": 57,
    "sdlk_colon": 58,
    "sdlk_semicolon": 59,
    "sdlk_less": 60,
    "sdlk_equals": 61,
    "sdlk_greater": 62,
    "sdlk_question": 63,
    "sdlk_at": 64,
    "sdlk_leftbracket": 91,
    "sdlk_backslash": 92,
    "sdlk_rightbracket": 93,
    "sdlk_caret": 94,
    "sdlk_underscore": 95,
    "sdlk_backquote": 96,
    "sdlk_a": 97,
    "sdlk_b": 98,
    "sdlk_c": 99,
    "sdlk_d": 100,
    "sdlk_e": 101,
    "sdlk_f": 102,
    "sdlk_g": 103,
    "sdlk_h": 104,
    "sdlk_i": 105,
    "sdlk_j": 106,
    "sdlk_k": 107,
    "sdlk_l": 108,
    "sdlk_m": 109,
    "sdlk_n": 110,
    "sdlk_o": 111,
    "sdlk_p": 112,
    "sdlk_q": 113,
    "sdlk_r": 114,
    "sdlk_s": 115,
    "sdlk_t": 116,
    "sdlk_u": 117,
    "sdlk_v": 118,
    "sdlk_w": 119,
    "sdlk_x": 120,
    "sdlk_y": 121,
    "sdlk_z": 122,
    "sdlk_delete": 127,
    "sdlk_world_0": 160,
    "sdlk_world_1": 161,
    "sdlk_world_2": 162,
    "sdlk_world_3": 163,
    "sdlk_world_4": 164,
    "sdlk_world_5": 165,
    "sdlk_world_6": 166,
    "sdlk_world_7": 167,
    "sdlk_world_8": 168,
    "sdlk_world_9": 169,
    "sdlk_world_10": 170,
    "sdlk_world_11": 171,
    "sdlk_world_12": 172,
    "sdlk_world_13": 173,
    "sdlk_world_14": 174,
    "sdlk_world_15": 175,
    "sdlk_world_16": 176,
    "sdlk_world_17": 177,
    "sdlk_world_18": 178,
    "sdlk_world_19": 179,
    "sdlk_world_20": 180,
    "sdlk_world_21": 181,
    "sdlk_world_22": 182,
    "sdlk_world_23": 183,
    "sdlk_world_24": 184,
    "sdlk_world_25": 185,
    "sdlk_world_26": 186,
    "sdlk_world_27": 187,
    "sdlk_world_28": 188,
    "sdlk_world_29": 189,
    "sdlk_world_30": 190,
    "sdlk_world_31": 191,
    "sdlk_world_32": 192,
    "sdlk_world_33": 193,
    "sdlk_world_34": 194,
    "sdlk_world_35": 195,
    "sdlk_world_36": 196,
    "sdlk_world_37": 197,
    "sdlk_world_38": 198,
    "sdlk_world_39": 199,
    "sdlk_world_40": 200,
    "sdlk_world_41": 201,
    "sdlk_world_42": 202,
    "sdlk_world_43": 203,
    "sdlk_world_44": 204,
    "sdlk_world_45": 205,
    "sdlk_world_46": 206,
    "sdlk_world_47": 207,
    "sdlk_world_48": 208,
    "sdlk_world_49": 209,
    "sdlk_world_50": 210,
    "sdlk_world_51": 211,
    "sdlk_world_52": 212,
    "sdlk_world_53": 213,
    "sdlk_world_54": 214,
    "sdlk_world_55": 215,
    "sdlk_world_56": 216,
    "sdlk_world_57": 217,
    "sdlk_world_58": 218,
    "sdlk_world_59": 219,
    "sdlk_world_60": 220,
    "sdlk_world_61": 221,
    "sdlk_world_62": 222,
    "sdlk_world_63": 223,
    "sdlk_world_64": 224,
    "sdlk_world_65": 225,
    "sdlk_world_66": 226,
    "sdlk_world_67": 227,
    "sdlk_world_68": 228,
    "sdlk_world_69": 229,
    "sdlk_world_70": 230,
    "sdlk_world_71": 231,
    "sdlk_world_72": 232,
    "sdlk_world_73": 233,
    "sdlk_world_74": 234,
    "sdlk_world_75": 235,
    "sdlk_world_76": 236,
    "sdlk_world_77": 237,
    "sdlk_world_78": 238,
    "sdlk_world_79": 239,
    "sdlk_world_80": 240,
    "sdlk_world_81": 241,
    "sdlk_world_82": 242,
    "sdlk_world_83": 243,
    "sdlk_world_84": 244,
    "sdlk_world_85": 245,
    "sdlk_world_86": 246,
    "sdlk_world_87": 247,
    "sdlk_world_88": 248,
    "sdlk_world_89": 249,
    "sdlk_world_90": 250,
    "sdlk_world_91": 251,
    "sdlk_world_92": 252,
    "sdlk_world_93": 253,
    "sdlk_world_94": 254,
    "sdlk_world_95": 255,
    "sdlk_kp0": 256,
    "sdlk_kp1": 257,
    "sdlk_kp2": 258,
    "sdlk_kp3": 259,
    "sdlk_kp4": 260,
    "sdlk_kp5": 261,
    "sdlk_kp6": 262,
    "sdlk_kp7": 263,
    "sdlk_kp8": 264,
    "sdlk_kp9": 265,
    "sdlk_kp_period": 266,
    "sdlk_kp_divide": 267,
    "sdlk_kp_multiply": 268,
    "sdlk_kp_minus": 269,
    "sdlk_kp_plus": 270,
    "sdlk_kp_enter": 271,
    "sdlk_kp_equals": 272,
    "sdlk_up": 273,
    "sdlk_down": 274,
    "sdlk_right": 275,
    "sdlk_left": 276,
    "sdlk_insert": 277,
    "sdlk_home": 278,
    "sdlk_end": 279,
    "sdlk_pageup": 280,
    "sdlk_pagedown": 281,
    "sdlk_f1": 282,
    "sdlk_f2": 283,
    "sdlk_f3": 284,
    "sdlk_f4": 285,
    "sdlk_f5": 286,
    "sdlk_f6": 287,
    "sdlk_f7": 288,
    "sdlk_f8": 289,
    "sdlk_f9": 290,
    "sdlk_f10": 291,
    "sdlk_f11": 292,
    "sdlk_f12": 293,
    "sdlk_f13": 294,
    "sdlk_f14": 295,
    "sdlk_f15": 296,
    "sdlk_numlock": 300,
    "sdlk_capslock": 301,
    "sdlk_scrollock": 302,
    "sdlk_rshift": 303,
    "sdlk_lshift": 304,
    "sdlk_rctrl": 305,
    "sdlk_lctrl": 306,
    "sdlk_ralt": 307,
    "sdlk_lalt": 308,
    "sdlk_rmeta": 309,
    "sdlk_lmeta": 310,
    "sdlk_lsuper": 311,
    "sdlk_rsuper": 312,
    "sdlk_mode": 313,
    "sdlk_compose": 314,
    "sdlk_help": 315,
    "sdlk_print": 316,
    "sdlk_sysreq": 317,
    "sdlk_break": 318,
    "sdlk_menu": 319,
    "sdlk_power": 320,
    "sdlk_euro": 321,
    "sdlk_undo": 322,
}

fd = os.open(PATH, os.O_RDWR | os.O_CREAT)
os.ftruncate(fd, SIZE)
mm = mmap.mmap(fd, SIZE, access=mmap.ACCESS_WRITE)
os.close(fd)

written = 0
header_size = struct.calcsize('I')
item_size = struct.calcsize('H')
mm.seek(header_size)

for item in args:
    if written > SIZE - header_size - item_size:
        # Don't overflow buffer
        break
    if code := keymap.get(item.lower()):
        mm.write(struct.pack('H', code))
        written += item_size

mm.write(struct.pack('H', 0x00))
mm.seek(0)
mm.write(struct.pack('I', 1))
mm.flush()
mm.close()

if written == 0:
    print("Error: Nothing written", file=sys.stderr)
    sys.exit(1)

sys.exit(0)
